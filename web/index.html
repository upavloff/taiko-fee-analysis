<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Research Specification Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .test { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background: #e8f5e8; border: 1px solid #28a745; }
        .error { background: #f8d7da; border: 1px solid #dc3545; }
        .info { background: #d1ecf1; border: 1px solid #0c5460; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>üî¨ Research Specification Test</h1>

    <div id="test-results"></div>

    <button onclick="runTests()">Run Research Specification Tests</button>

    <div id="simulation-output" style="margin-top: 20px;"></div>

    <!-- Load components in correct order -->
    <script src="components/specs-simulator.js"></script>
    <script src="components/simulator.js"></script>

    <script>
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `test ${type}`;
            div.innerHTML = message;
            document.getElementById('test-results').appendChild(div);
            console.log(message);
        }

        async function runTests() {
            document.getElementById('test-results').innerHTML = '';
            log('üî¨ Starting Research Specification Tests', 'info');

            try {
                // Test 1: Check if ResearchSimulationEngine is available
                if (typeof ResearchSimulationEngine === 'undefined') {
                    log('‚ùå ResearchSimulationEngine not found', 'error');
                    return;
                }
                log('‚úÖ ResearchSimulationEngine loaded', 'success');

                // Test 2: Check AlphaSimulationEngine alias
                if (typeof AlphaSimulationEngine === 'undefined') {
                    log('‚ùå AlphaSimulationEngine alias not found', 'error');
                    return;
                }
                log('‚úÖ AlphaSimulationEngine alias available', 'success');

                // Test 3: Create ResearchSimulationEngine instance with research parameters
                const engine = new ResearchSimulationEngine({
                    mu: 0.7,
                    alpha_data: 0.18,
                    nu: 0.2,
                    H: 72,
                    Q_bar: 20000,
                    targetBalance: 1000.0,
                    vaultInit: 'target',
                    l1Source: 'simulated',
                    l1Volatility: 0.1,
                    seed: 42,
                    txsPerBatch: 100
                });
                log('‚úÖ ResearchSimulationEngine instance created', 'success');
                log(`   Research Parameters: Œº=${engine.mu}, Œ±_data=${engine.alpha_data}, ŒΩ=${engine.nu}, H=${engine.H}`, 'info');

                // Test 4: Verify fee controller type
                if (typeof ResearchFeeController === 'undefined') {
                    log('‚ùå ResearchFeeController not found', 'error');
                    return;
                }
                log('‚úÖ ResearchFeeController available', 'success');

                // Test 5: Verify L1 basefee smoother
                if (typeof L1BasefeeSmoother === 'undefined') {
                    log('‚ùå L1BasefeeSmoother not found', 'error');
                    return;
                }
                log('‚úÖ L1BasefeeSmoother available', 'success');

                // Test 6: Run short simulation using alias
                log('üîÑ Running simulation via AlphaSimulationEngine alias (50 steps)...', 'info');
                const aliasEngine = new AlphaSimulationEngine({
                    mu: 0.7,
                    alpha_data: 0.18,
                    nu: 0.2,
                    H: 72,
                    targetBalance: 1000.0,
                    vaultInit: 'target',
                    l1Source: 'simulated',
                    seed: 42,
                    txsPerBatch: 100
                });

                const simulationData = await aliasEngine.runSimulation(50);

                // Test 7: Check return format
                if (Array.isArray(simulationData)) {
                    log(`‚úÖ Simulation returned array with ${simulationData.length} steps`, 'success');
                } else {
                    log('‚ùå Simulation returned object instead of array', 'error');
                    log(`   Type: ${typeof simulationData}, Keys: ${Object.keys(simulationData)}`, 'error');
                    return;
                }

                // Test 8: Check research specification data structure
                if (simulationData.length > 0) {
                    const sample = simulationData[0];
                    const expectedFields = ['timeStep', 'l1Basefee', 'l1BasefeeSmooth', 'estimatedFee', 'vaultBalance', 'alpha_data_used', 'mu_used', 'nu_used'];
                    const hasAllFields = expectedFields.every(field => field in sample);

                    if (hasAllFields) {
                        log('‚úÖ Research data structure correct', 'success');
                        log(`   Sample: timeStep=${sample.timeStep}, L1=${sample.l1Basefee.toFixed(3)} gwei, L1_smooth=${sample.l1BasefeeSmooth.toFixed(3)} gwei, L2=${sample.estimatedFee.toFixed(3)} gwei`, 'info');
                        log(`   Parameters: Œº=${sample.mu_used}, Œ±_data=${sample.alpha_data_used}, ŒΩ=${sample.nu_used}`, 'info');
                    } else {
                        log('‚ùå Missing expected fields', 'error');
                        log(`   Fields: ${Object.keys(sample)}`, 'error');
                        log(`   Expected: ${expectedFields}`, 'error');
                    }
                }

                // Test 9: Verify EMA smoothing is working
                if (simulationData.length > 5) {
                    const rawL1Values = simulationData.slice(0, 5).map(d => d.l1Basefee);
                    const smoothL1Values = simulationData.slice(0, 5).map(d => d.l1BasefeeSmooth);

                    // Check if smoothed values are different from raw (indicating smoothing is active)
                    const smoothingActive = smoothL1Values.some((smooth, i) => Math.abs(smooth - rawL1Values[i]) > 0.001);

                    if (smoothingActive) {
                        log('‚úÖ EMA smoothing is active', 'success');
                    } else {
                        log('‚ö†Ô∏è EMA smoothing may not be working properly', 'info');
                    }
                }

                // Test 10: Display simulation sample
                const outputDiv = document.getElementById('simulation-output');
                outputDiv.innerHTML = `
                    <h3>üìä Research Specification Simulation Sample (First 5 Steps)</h3>
                    <pre>${JSON.stringify(simulationData.slice(0, 5), null, 2)}</pre>
                `;

                log('üéâ All research specification tests passed!', 'success');

            } catch (error) {
                log(`‚ùå Test failed: ${error.message}`, 'error');
                log(`   Stack: ${error.stack}`, 'error');
            }
        }

        // Auto-run tests on load
        window.addEventListener('load', () => {
            setTimeout(runTests, 500);
        });
    </script>
</body>
</html>