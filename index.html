<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taiko Fee Mechanism Explorer</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjs@11.11.0/lib/browser/math.min.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
            }
        };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Left Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>Taiko Fee Explorer</h1>
            </div>


            <!-- Parameter Controls -->
            <div class="parameters-section">
                <h3>Parameter Controls</h3>

                <!-- Mu Parameter -->
                <div class="parameter-group">
                    <label for="mu-slider" class="parameter-label">
                        Œº (L1 Weight): <span id="mu-value">0.0</span>
                        <span class="tooltip" data-tooltip="Controls how much L1 costs influence L2 fees. L1 costs are calculated as: (trend L1 basefee √ó gas per L2 tx). Gas per tx = batch gas cost √∑ transactions per batch. Higher Œº values make L2 fees track L1 conditions more closely.">‚ÑπÔ∏è</span>
                    </label>
                    <input type="range" id="mu-slider" class="parameter-slider" min="0" max="1" step="0.05" value="0.0">
                    <div class="range-labels">
                        <span>0.0</span>
                        <span>1.0</span>
                    </div>
                </div>

                <!-- Nu Parameter -->
                <div class="parameter-group">
                    <label for="nu-slider" class="parameter-label">
                        ŒΩ (Deficit Weight): <span id="nu-value">0.3</span>
                        <span class="tooltip" data-tooltip="Controls strength of vault deficit correction. Higher values = faster correction. 0 = no deficit correction, 1 = maximum correction.">‚ÑπÔ∏è</span>
                    </label>
                    <input type="range" id="nu-slider" class="parameter-slider" min="0" max="1" step="0.05" value="0.3">
                    <div class="range-labels">
                        <span>0.0</span>
                        <span>1.0</span>
                    </div>
                </div>

                <!-- H Parameter -->
                <div class="parameter-group">
                    <label for="H-slider" class="parameter-label">
                        H (Horizon): <span id="H-value">288</span> steps
                        <span class="tooltip" data-tooltip="Time horizon for L1 cost prediction. 144 steps ‚âà 1 day.">‚ÑπÔ∏è</span>
                    </label>
                    <input type="range" id="H-slider" class="parameter-slider" min="24" max="576" step="24" value="288">
                    <div class="range-labels">
                        <span>24</span>
                        <span>576</span>
                    </div>
                </div>

                <!-- Transactions Per Block -->
                <div class="parameter-group">
                    <label for="tx-per-block-slider" class="parameter-label">
                        Transactions Per L1 Batch: <span id="tx-per-block-value">100</span>
                        <span class="tooltip" data-tooltip="Number of transactions per L1 batch submission. Gas cost per tx = 200k gas √∑ txs per batch. Higher values = lower gas cost per tx. Matches Python implementation defaults.">‚ÑπÔ∏è</span>
                    </label>
                    <input type="range" id="tx-per-block-slider" class="parameter-slider" min="50" max="500" step="10" value="100">
                    <div class="range-labels">
                        <span>50</span>
                        <span>500</span>
                    </div>
                </div>

                <!-- Vault Initialization -->
                <div class="parameter-group">
                    <label for="vault-init" class="parameter-label">
                        Vault Init
                        <span class="tooltip" data-tooltip="Starting vault balance. Critical for meaningful analysis.">‚ÑπÔ∏è</span>
                    </label>
                    <select id="vault-init" class="parameter-select">
                        <option value="target">At Target</option>
                        <option value="underfunded-20">20% Underfunded</option>
                        <option value="underfunded-50">50% Underfunded</option>
                        <option value="overfunded-20">20% Overfunded</option>
                    </select>
                </div>

                <!-- Guaranteed Recovery Toggle -->
                <div class="parameter-group">
                    <label class="parameter-label">
                        Deficit Recovery Mode
                        <span class="tooltip" data-tooltip="Standard: Uses asymptotic correction (ŒΩ√óD/H). Guaranteed: Adds minimum rate to ensure complete recovery to target balance.">‚ÑπÔ∏è</span>
                    </label>
                    <div class="toggle-container">
                        <input type="checkbox" id="guaranteed-recovery" class="toggle-checkbox">
                        <label for="guaranteed-recovery" class="toggle-switch">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="toggle-label">Guaranteed Recovery</span>
                    </div>
                    <div class="parameter-description">
                        Prevents asymptotic stalling near target balance
                    </div>

                    <!-- Minimum Deficit Rate (visible only when guaranteed recovery is enabled) -->
                    <div id="min-deficit-rate-group" class="sub-parameter-group" style="display: none; margin-top: 10px;">
                        <label for="min-deficit-rate-slider" class="parameter-label">
                            Min Deficit Rate: <span id="min-deficit-rate-value">0.001</span> ETH/step
                            <span class="tooltip" data-tooltip="Minimum deficit correction rate per step when guaranteed recovery is active. Higher values = faster recovery.">‚ÑπÔ∏è</span>
                        </label>
                        <input type="range" id="min-deficit-rate-slider" class="parameter-slider" min="-6" max="-2" step="0.2" value="-3">
                        <div class="range-labels">
                            <span>1e-6</span>
                            <span>1e-2</span>
                        </div>
                    </div>
                </div>

                <!-- L1 Data Source Tabs -->
                <div class="parameter-group">
                    <label class="parameter-label">
                        L1 Base Fee Data Source
                        <span class="tooltip" data-tooltip="Choose between historical Ethereum data or simulated GBM model">‚ÑπÔ∏è</span>
                    </label>

                    <!-- Tab Navigation -->
                    <div class="tab-navigation">
                        <button class="tab-button active" data-tab="historical">Historical</button>
                        <button class="tab-button" data-tab="simulated">Simulated</button>
                    </div>

                    <!-- Tab Content -->
                    <div class="tab-content">
                        <!-- Historical Tab -->
                        <div class="tab-pane active" id="historical-tab">
                            <div class="historical-periods-list">
                                <label class="period-option">
                                    <input type="radio" name="historical-period" value="may2023" checked>
                                    <div class="period-content">
                                        <div class="period-title">May 2023 PEPE Crisis</div>
                                        <div class="period-description">Memecoin mania extreme fees (60-184 gwei)</div>
                                    </div>
                                </label>
                                <label class="period-option">
                                    <input type="radio" name="historical-period" value="may2022">
                                    <div class="period-content">
                                        <div class="period-title">May 2022 Crash</div>
                                        <div class="period-description">UST/Luna collapse (53-533 gwei)</div>
                                    </div>
                                </label>
                                <label class="period-option">
                                    <input type="radio" name="historical-period" value="june2022">
                                    <div class="period-content">
                                        <div class="period-title">July 2022 Real Market Volatility</div>
                                        <div class="period-description">Actual Ethereum data (7-88 gwei)</div>
                                    </div>
                                </label>
                                <label class="period-option">
                                    <input type="radio" name="historical-period" value="recent">
                                    <div class="period-content">
                                        <div class="period-title">Recent Low Fees (3h)</div>
                                        <div class="period-description">Nov 2025 (0.055-0.092 gwei)</div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Simulated Tab -->
                        <div class="tab-pane" id="simulated-tab">
                            <!-- Simulation Seed -->
                            <div class="sub-parameter-group">
                                <label for="seed-input" class="parameter-label">
                                    Simulation Seed
                                    <span class="tooltip" data-tooltip="Random seed for reproducible simulations">‚ÑπÔ∏è</span>
                                </label>
                                <input type="number" id="seed-input" class="parameter-input" value="42" min="0" max="999999">
                            </div>

                            <!-- L1 Volatility -->
                            <div class="sub-parameter-group">
                                <label for="volatility-slider" class="parameter-label">
                                    L1 Volatility: <span id="volatility-value">0.3</span>
                                    <span class="tooltip" data-tooltip="Simulated L1 market volatility. 0.3 = normal, 0.8 = crisis.">‚ÑπÔ∏è</span>
                                </label>
                                <input type="range" id="volatility-slider" class="parameter-slider" min="0.1" max="1.0" step="0.1" value="0.3">
                                <div class="range-labels">
                                    <span>0.1</span>
                                    <span>1.0</span>
                                </div>
                            </div>

                            <!-- Duration Control -->
                            <div class="sub-parameter-group">
                                <label for="duration-slider" class="parameter-label">
                                    Simulation Duration: <span id="duration-value">3.0</span> hours
                                    <span class="tooltip" data-tooltip="Length of simulation. 1h for quick tests, 6h for thorough analysis. Each step = 2 seconds (Taiko block time).">‚ÑπÔ∏è</span>
                                </label>
                                <input type="range" id="duration-slider" class="parameter-slider" min="1" max="6" step="0.5" value="3">
                                <div class="range-labels">
                                    <span>1h</span>
                                    <span>6h</span>
                                </div>
                            </div>

                            <!-- Spike Delay -->
                            <div class="sub-parameter-group">
                                <label for="spike-delay-slider" class="parameter-label">
                                    Spike Delay: <span id="spike-delay-value">50</span>%
                                    <span class="tooltip" data-tooltip="When the volatility spike starts as percentage of total simulation time. 50% = middle of simulation.">‚ÑπÔ∏è</span>
                                </label>
                                <input type="range" id="spike-delay-slider" class="parameter-slider" min="0" max="90" step="5" value="50">
                                <div class="range-labels">
                                    <span>0%</span>
                                    <span>90%</span>
                                </div>
                            </div>

                            <!-- Spike Height -->
                            <div class="sub-parameter-group">
                                <label for="spike-height-slider" class="parameter-label">
                                    Spike Height: <span id="spike-height-value">0.3</span>
                                    <span class="tooltip" data-tooltip="Intensity of the spike. 0.1 = mild, 0.3 = moderate, 0.5 = extreme.">‚ÑπÔ∏è</span>
                                </label>
                                <input type="range" id="spike-height-slider" class="parameter-slider" min="0.1" max="0.8" step="0.1" value="0.3">
                                <div class="range-labels">
                                    <span>0.1</span>
                                    <span>0.8</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Presets -->
            <div class="preset-section">
                <h3>üéØ Optimal Presets</h3>
                <p class="preset-description">Hover over each preset for objectives & constraints. Click (‚ìò) for detailed analysis.</p>
                <div class="preset-buttons">
                    <button class="preset-btn featured" data-preset="optimal" data-tooltip="üéØ OBJECTIVE: Minimize user fees while maintaining vault solvency | CONSTRAINT: Vault must remain funded (time underfunded < 1%)">
                        üéØ Optimal
                        <span class="preset-tooltip-trigger">‚ìò</span>
                    </button>
                    <button class="preset-btn" data-preset="balanced" data-tooltip="‚öñÔ∏è OBJECTIVE: Balance fee minimization with risk management | CONSTRAINT: Maintain vault stability with low volatility tolerance">
                        ‚öñÔ∏è Balanced
                        <span class="preset-tooltip-trigger">‚ìò</span>
                    </button>
                    <button class="preset-btn" data-preset="crisis-resilient" data-tooltip="‚õëÔ∏è OBJECTIVE: Maximize protocol robustness and vault recovery speed | CONSTRAINT: Vault must recover quickly from any deficit state">
                        ‚õëÔ∏è Crisis-Resilient
                        <span class="preset-tooltip-trigger">‚ìò</span>
                    </button>
                </div>

                <!-- Detailed Preset Tooltips -->
                <div id="preset-tooltip-modal" class="preset-tooltip-modal" style="display: none;">
                    <div class="preset-tooltip-content">
                        <div class="preset-tooltip-header">
                            <h4 id="preset-tooltip-title"></h4>
                            <button class="preset-tooltip-close">&times;</button>
                        </div>
                        <div class="preset-tooltip-body">
                            <div id="preset-tooltip-details"></div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Fee Formula Header -->
            <div class="formula-header">
                <div class="formula-content">
                    <h2>Taiko Fee Mechanism</h2>
                    <div class="formula-container-main">
                        $$F_E(t) = \max\left(\mu \times C_{L1}(t) + \nu \times \frac{D(t)}{H}, F_{\text{min}}\right)$$
                        <button id="formula-info-btn" class="formula-info-btn" title="Toggle formula parameters">‚ìò</button>
                    </div>
                    <!-- Compact Info Box -->
                    <div id="formula-info-box" class="formula-info-box" style="display: none;">
                        <div class="info-grid">
                            <div class="info-item">
                                <strong>Main Formula Variables:</strong><br>
                                $F_E(t)$: Estimated fee at time t | $\mu$: L1 weight (<span id="info-mu">0.4</span>) | $\nu$: Deficit weight (<span id="info-nu">0.3</span>)<br>
                                $C_{L1}(t)$: L1 cost per tx | $D(t)$: Vault deficit | $H$: Horizon (<span id="info-h">144</span> steps) | $F_{\min}$: Min fee (1e-8 ETH)
                            </div>
                            <div class="info-item">
                                <strong>L1 Cost Calculation:</strong><br>
                                $$C_{L1}(t) = \frac{\text{BaseFee}_{L1}(t) \times \text{Gas}_{\text{per tx}}}{10^{18}}$$
                                Where:<br>
                                ‚Ä¢ $\text{BaseFee}_{L1}(t)$ = Current L1 basefee at time $t$ (in wei)<br>
                                ‚Ä¢ $\text{Gas}_{\text{per tx}} = \max\left(\frac{200{,}000}{\text{Expected Tx Volume}}, 200\right)$ gas<br>
                                ‚Ä¢ Economies of scale: Higher expected volume ‚Üí Lower gas cost per transaction<br>
                                ‚Ä¢ Floor at 200 gas accounts for minimum batch overhead
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="charts-section">
                <div class="charts-grid">
                    <div class="chart-container">
                        <canvas id="fee-chart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="vault-chart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="l1-chart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="correlation-chart"></canvas>
                    </div>
                </div>
                <!-- Loading Overlay -->
                <div id="loading-overlay" class="loading-overlay" style="display: none;">
                    <div class="spinner"></div>
                    <p>Running simulation...</p>
                </div>
            </div>

            <!-- Performance Metrics -->
            <div class="metrics-section">
                <h3>Performance Metrics</h3>
                <div class="metrics-grid">
                    <div class="metric-card" id="avg-fee-card">
                        <div class="metric-label">Average Taiko Estimated Fee per Gas</div>
                        <div class="metric-value" id="avg-fee-value">-</div>
                        <div class="metric-unit">gwei</div>
                        <div class="metric-status" id="avg-fee-status"></div>
                    </div>
                    <div class="metric-card" id="fee-cv-card">
                        <div class="metric-label">Taiko Estimated Fee Variability</div>
                        <div class="metric-value" id="fee-cv-value">-</div>
                        <div class="metric-unit">CV</div>
                        <div class="metric-status" id="fee-cv-status"></div>
                    </div>
                    <div class="metric-card" id="underfunded-card">
                        <div class="metric-label">Time Underfunded</div>
                        <div class="metric-value" id="underfunded-value">-</div>
                        <div class="metric-unit">%</div>
                        <div class="metric-status" id="underfunded-status"></div>
                    </div>
                    <div class="metric-card" id="tracking-card">
                        <div class="metric-label">L1 Tracking Error</div>
                        <div class="metric-value" id="tracking-value">-</div>
                        <div class="metric-unit">ratio</div>
                        <div class="metric-status" id="tracking-status"></div>
                    </div>
                </div>

                <!-- Metrics Explanation -->
                <div class="metrics-explanation">
                    <h4>Metric Interpretation</h4>
                    <div class="explanation-grid">
                        <div class="explanation-item">
                            <strong>Average Taiko Estimated Fee per Gas:</strong> Mean gas cost over simulation period. Lower values reduce user burden but must cover L1 operational costs. Comparable to L1 basefee.
                        </div>
                        <div class="explanation-item">
                            <strong>Taiko Estimated Fee Variability (CV):</strong> Coefficient of variation measuring fee stability.
                            <span class="threshold">Excellent: &lt;0.5, Good: 0.5-1.0, Poor: &gt;1.0</span>
                        </div>
                        <div class="explanation-item">
                            <strong>Time Underfunded:</strong> Percentage of simulation time with vault deficit > 0.01% of target balance.
                            <span class="threshold">Excellent: &lt;5%, Good: 5-15%, Poor: &gt;15%</span>
                        </div>
                        <div class="explanation-item">
                            <strong>L1 Tracking Error:</strong> Deviation between fees and actual L1 costs (normalized standard deviation).
                            <span class="threshold">Excellent: &lt;0.3, Good: 0.3-0.6, Poor: &gt;0.6</span>
                        </div>
                    </div>
                </div>

                <!-- L1 Cost Estimation Analysis Chart -->
                <div class="l1-estimation-section">
                    <h4>L1 Cost Estimation Analysis</h4>
                    <div class="chart-container-single">
                        <canvas id="l1-estimation-chart"></canvas>
                    </div>
                    <div class="estimation-explanation">
                        <p><strong>Trend vs Spot L1 Basefee:</strong> Shows how the smoothed trend basefee (used for L2 fee calculation) compares to actual spot L1 basefee. The trend approach reduces fee volatility while maintaining cost coverage. When Œº=0, this chart shows the underlying L1 dynamics without affecting L2 fees.</p>
                    </div>
                </div>

            </div>
        </div>
    </div>



    <!-- Scripts -->
    <script src="simulator.js"></script>
    <script src="charts.js"></script>
    <script src="app.js"></script>
</body>
</html>